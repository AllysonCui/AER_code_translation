Overview: The code in this replication package constructs the analysis file from two main data sources, specifically Medicaid and Medicare administrative data respectively (CMS 2023a, CMS 2023b, CMS 2023c, IBM 2016) using Stata. One set of files generate the base analytic files. Another set of files is employed to conduct the different analyses. The replicator should expect the code to run for about 20 hours.
************************************************
Data availability and provenance: The data for this project are confidential, but may be obtained by executing research Data Use Agreements with the Centers for Medicare and Medicaid Services, via ResDAC. Researchers interested in access to the data may contact ResDAC at resdac@umn.edu; researchers interested in accessing this data at NBER specifically, who have the necessary NBER affiliations, may contact Mohan Ramanujan at mohan@nber.org. It can take many months to negotiate data use agreements and gain access to the data. The author will assist with any reasonable replication attempts for five years following publication.
************************************************
Statement about rights: We certify that the authors of the manuscript have legitimate access to and permission to use the data used in this manuscript.
***********************************
Instructions for replicator: Install distinct and estout Stata packages. Install/load the following Python packages: import pandas as pd; import numpy as np; from scipy.special import roots_hermite as hg; from scipy.special import eval_hermite as hermite; from scipy.stats import norm; from scipy.optimize import minimize; from numpy import dot,sqrt,pi,log,sum,mean,exp,var; import matplotlib as plt; import random. Then, follow data building and analysis steps sequentially, based on list below. Start by constructing active choice indicator, then different analytics samples, then the data build itself, and finally proceed with the analysis. 

************************************************
List of precollected data files-generated by external parties-that are inputs to our own data build:  

*********
Medicare Part D plan characteristics and related data:
*********

*Main plan characteristics file (tracks 'benchmark', plan exit status)
Data description and dictionary link: https://resdac.org/cms-data/files/plan-characteristics
Data location: "/disk/agedisk3/medicare.work/duggan-DUA51935/extracts/pln/"

*Part D formulary data
Data description and dictionary link: https://www.cms.gov/Research-Statistics-Data-and-Systems/Files-for-Order/NonIdentifiableDataFiles/PrescriptionDrugPlanFormularyPharmacyNetworkandPricingInformationFiles
Data location: "/homes/data/cms/formulary/"

*Redbook drug description data
Data description: https://theclearcenter.org/wp-content/uploads/2020/01/IBM-MarketScan-Data-Dictionary.pdf
Data location: "/disk/homedirs/adywang-dua51935/duggan-DUA51935/adywang-dua51935/svn/trunk/raw/redbook/data/redbook.dta"

*Medicare/Medicaid beneficiary crosswalk file (to be able to standardize beneficiary ID's across the two different insurance, and follow same beneficiary across Medicaid and Medicare data: 
Dictionary link: N/A
Data location:  "/disk/homedirs/adywang-dua51935/duggan-DUA51935/adywang-dua51935/svn/trunk/raw/medicare_medicaid_crosswalk/data/bene_bene_xwalk"

*********
Medicaid files:
*********
*Enrollment files: MAX personal summary files (PS), covering NY and Texas, 2004-2010
*Claim files: MAX inpatient (IP), outpatient (OT), and prescription drug files (RX), covering NY and Texas, 2004-2010 
Data Location: PS files: "/disk/homedirs/adywang-dua51935/duggan-DUA51935/adywang-dua51935/svn/trunk/raw/medicaid_ps/", IP: "/disk/homedirs/adywang-dua51935/duggan-DUA51935/adywang-dua51935/svn/trunk/raw/medicaid_ip/", OT: "/disk/homedirs/adywang-dua51935/duggan-DUA51935/adywang-dua51935/svn/trunk/raw/medicaid_ot/", RX: /disk/homedirs/adywang-dua51935/duggan-DUA51935/adywang-dua51935/svn/trunk/raw/medicaid_rx/"
Description and dictionary files: https://www2.ccwdata.org/web/guest/data-dictionaries

*********
Medicare files:
*********
*Enrollment files, nationwide, covering 2007-2015 (MBSF)
*Claim files: 20% nationwide sample, for 2007-2015: MedPAR (inpatient and SNF), institutional outpatient (Outpatient), professional (Carrier), RX (Part D Event File)
*Choice type files: plan election type file (ELC), 2017-2015
Data Location: MedPAR-"/disk/agedisk3/medicare.work/duggan-DUA51935/bvabson-dua51935/svn/svn/trunk/derived/utilization_med_monthly/output/utilization.dta", Outpatient: "/disk/agedisk3/medicare.work/duggan-DUA51935/bvabson-dua51935/svn/svn/trunk/derived/utilization_op_monthly/output/utilization.dta", Carrier: "/disk/agedisk3/medicare.work/duggan-DUA51935/bvabson-dua51935/svn/svn/trunk/derived/utilization_car_monthly/output/utilization.dta", RX: "/disk/agedisk3/medicare.work/duggan-DUA51935/bvabson-dua51935/svn/svn/trunk/derived/utilization_pde_monthly/output/utilization.dta", MBSF: "/disk/agedisk3/medicare.work/duggan-DUA51935/bvabson-dua51935/svn/svn/trunk/raw/medicare_part_ab_bsf/data"
Description and dictionary files: https://www2.ccwdata.org/web/guest/data-dictionaries

Crosswalks for standardizing Part D plan ID's over time
Data description and dictionary link: https://www.cms.gov/research-statistics-data-and-systems/statistics-trends-and-reports/mcradvpartdenroldata/plan-crosswalks
Data location: "/disk/agedisk3/medicare.work/duggan-DUA51935/extracts/pln/"

*********************************************************
Software requirements:
These files were run using Stata 16 as well as Python 3.8.1.
*********************************************************
Controlled Randomness: set random seed to 1 in line 30 of program rdoutcomes_regs.do
*********************************************************

Memory and Runtime requirements:
Require approximately 32 gb of ram to run, as well as around 1 tb of hard drive space. Run time approximately 20 hours.

*********************************************************
(I) Build
*********************************************************

Generate key LHS variable-active choice by bene-id year:

(1) Generate active choice indicators
build_elc_actv.do

(2) Prep work
*ListToDrop.do helps refine active choice sample
*BenchmarkAnalysis.do constructs set of exit plans, set of benchmark plans, and benchmark running variable (all of which feed into sample construction)

***Primary sample construction (3)-(6)

(3) RD samples: at person-year; Those in benchmark plans in pre-year (some of which do/do not lose benchmark in post-year)

build_mcr_us_RD_samp.do 
build_mcr_us_RD_samp_20pct_sample.do 


(4) Exit samples (those in exiting Part D plans); by person-year. 
BenchmarkAnalysis.do-Identifies set of exiting plans
build_mcr_us_exit.do-Builds out sample of beneficiaries in those exiting plans 

(5) Initial enrollees in Medicare at 65 samples
build_mcr_init.do 
b: Subsample limited to those in NY/TX Medicaid pre-65
build_mcd.do 
build_mcr_mcd_nytx_merge.do

(6) 20% full LIS sample (not restricted to benchmark or exiting plans or random assignees; nationwide in scope)
build_summary_stats_sample.do

*********

**Generation of full analysis file: RD (reassignee sample)

(7): Variable construction to feed into event study analysis: 
A-Spend variable (covering RX, outpatient, inpatient, professional, respectively): build_rx, build_op, build_medpar, build_car; build_mcr_us_RD_samp_20pct_sample_high_benefit_drugs.do 
build_standardized_spending_chronic_drugs_by_year.do 
B-Base Formulary: FormularyConstruction.do
C-Elixhauser Score: build_elixhauser
D-Enrollment: 
i. Clean up of plan ID's: build_plandata.do
ii. Quarterly level enrollment file: enroll_panel.do, 
iii. Year level enrollment file: build_enrollmentdata.do
E-Unique NDC Count: build_NDC.do
F-Active choice status (incorporating in active choice status post-assignment & pre-enrollment); accounting for edge case: elc_actv_accountcancelled.do, rdoutcomes_newsamp.do
G-Running Variable: BenchmarkAnalysis.do
H-Within-person fit measure, for benchmark plans: Construct_RDFit.do
I-Fit measure for incumbent plans: Construct_OnePlan_Fin.do

(8): Event study data construction: 
i. Merge in person-quarter level outcomes around events: rdoutcomes_dataconstruction.do
ii. Construct different helper variables needed for event study regression: rd_outcomes_regs.do

(9): Event study analysis, along with main results and regression tables: rdoutcomes_eventstudyregs.do

****Generation of full analysis file: Initial enrollees

(10)
*Build Medicaid linked analysis file-based on raw fit: build_upd.do
*Build Medicaid linked analysis file-based on within-person fit: fit_effect_upd.do

****Generation of analysis file: Plan exit sample:
(11)
*Build exit data sample, linked to elixhauser file and prepped for regs: exit_data.do

***********************************************************************************

*****************************************************
(II) Analysis
*****************************************************

Figure 1A: fig_1a_code.do, lines 69-70
Figure 1B: fig_1b_a25.do, lines 17-19
Figure 2: rd_histogram_main_fig_2_3_4_a5_a6_a7_a8_a9_a10.do, lines 339-341
Figure 3: rd_histogram_main_fig_2_3_4_a5_a6_a7_a8_a9_a10.do, lines 399-408
Figure 4: rd_histogram_main_fig_2_3_4_a5_a6_a7_a8_a9_a10.do, lines 441-445
Figure 5: rd_event_study_1yr_post_fig_5_6_a12_a13_a26.do, lines 235-245, 259-271
Figure 6: rd_event_study_1yr_post_fig_5_6_a12_a13_a26.do, lines 280-292
Figure 7: "Part_D_rational_inattention.do", lines 14-50
***********

Table 1: summary_stats_tab_1.do, lines 170-347 
Table 2: rdoutcomes_eventstudyregs.do, lines 182-191
Table 3: rdoutcomes_eventstudyregs.do, lines 197-216
Table 4: rdoutcomes_eventstudyregs.do, lines 197-216
Table 5: rdoutcomes_eventstudyregs.do, lines 221-237
Table 6: rdoutcomes_eventstudyregs.do, lines 335-397
Table 7: Producing cells using "exit_cells_for_tab_7.do", lines 52-74, then structural analysis using "exit_struct.py"
Addressing referee comments: rdoutcomes_eventstudyregs.do, lines 425-458
***********

Appendix Figure A1: build_nytx_elixhauser_fig_a1_a2.do, lines 178-180
Appendix Figure A2: build_nytx_elixhauser_fig_a1_a2.do, lines 167-169
Appendix Figure A3: fig_a3_a19_a20_a21.do, lines 92-94
Appendix Figure A4: premium_transit_fig_a4.do, lines 23-24
Appendix Figure A5: rd_histogram_main_fig_2_3_4_a5_a6_a7_a8_a9_a10.do, lines 355-357
Appendix Figure A6: rd_histogram_main_fig_2_3_4_a5_a6_a7_a8_a9_a10.do, lines 372-375
Appendix Figure A7: rd_histogram_main_fig_2_3_4_a5_a6_a7_a8_a9_a10.do, lines 399-408
Appendix Figure A8: rd_histogram_main_fig_2_3_4_a5_a6_a7_a8_a9_a10.do, lines 503-512
Appendix Figure A9: rd_histogram_main_fig_2_3_4_a5_a6_a7_a8_a9_a10.do, lines 456-462
Appendix Figure A10: rd_histogram_main_fig_2_3_4_a5_a6_a7_a8_a9_a10.do, lines 448-452
Appendix Figure A11: plot_histogram.do, lines 6-10
Appendix Figures A12: rd_event_study_1yr_post_fig_5_6_a12_a13_a26.do, lines 235-271
Appendix Figures A13: rd_event_study_1yr_post_fig_5_6_a12_a13_a26.do, lines 280-292
Appendix Figure A14: [Using coefficients produced elsewhere] "Part_D_rational_inattention.do", lines 28-30
Appendix Figure A15-A16: [Using coefficients produced elsewhere] "Part_D_rational_inattention.do", lines 37-54
Appendix Figures A17-A18: N/A
Appendix Figure A19: fig_a3_a19_a20_a21.do, lines 52-56
Appendix Figure A20: fig_a3_a19_a20_a21.do, lines 52-56
Appendix Figure A21: fig_a3_a19_a20_a21.do, lines 100-103
Appendix Figure A22: fig_a22_a23_a24.do, lines 16-20
Appendix Figure A23: fig_a22_a23_a24.do, lines 16-20
Appendix Figure A24: fig_a22_a23_a24.do, lines 47-49
Appendix Figure A25: fig_1b_a25.do, lines 33-35
Appendix Figure A26: rd_event_study_1yr_post_fig_5_6_a12_a13_a26.do, lines 301-313
Appendix Figure A27: rd_event_study_2yr_post_fig_a27_a28_a29_a30.do, lines 165-173 
Appendix Figure A28: rd_event_study_2yr_post_fig_a27_a28_a29_a30.do, lines 180-190 
Appendix Figure A29: rd_event_study_2yr_post_fig_a27_a28_a29_a30.do, lines 193-203 
Appendix Figure A30: rd_event_study_2yr_post_fig_a27_a28_a29_a30.do, lines 193-203 
Appendix Figure A31+: [There is no code to generate these figures, as they do not use data.]
***********
Appendix Table A1: rd_histogram_main_fig_3_4_5_a6_a7_a8_a9_a10.do, lines 422-426 
Appendix Table A2: rdoutcomes_eventstudyregs, lines 242-248
Appendix Table A3: rd_event_study_1yr_post_fig_5_6_a12_a13_a26.do, lines 247-253
Appendix Table A4: rd_event_study_1yr_post_fig_5_6_a12_a13_a26.do, lines 275-279
Appendix Table A5: rdoutcomes_eventstudyregs, lines 276-325
Appendix Table A6: rdoutcomes_eventstudyregs, lines 335-397
Appendix Table A7: exit_appendix_table.do, lines 42-108


***************
References
***************

Centers for Medicare and Medicaid Services (CMS), 2023. Medicaid MAX claims and enrollment files. Information available at: https://www.cms.gov/research-statistics-data-and-systems/computer-data-and-systems/medicaiddatasourcesgeninfo/maxgeneralinformation

Centers for Medicare and Medicaid Services (CMS), 2023. Medicare claims and enrollment files. Information available at: https://www2.ccwdata.org/web/guest/data-dictionaries under Medicare claim and enrollment file sections

Centers for Medicare and Medicaid Services (CMS), 2023. Prescription drug formulary data. Information available at: https://www.cms.gov/Research-Statistics-Data-and-Systems/Files-for-Order/NonIdentifiableDataFiles/PrescriptionDrugPlanFormularyPharmacyNetworkandPricingInformationFiles
Data location: "/homes/data/cms/formulary/"


IBM, 2016. Truven Marketscan data. Information available at: https://theclearcenter.org/wp-content/uploads/2020/01/IBM-MarketScan-Data-Dictionary.pdf