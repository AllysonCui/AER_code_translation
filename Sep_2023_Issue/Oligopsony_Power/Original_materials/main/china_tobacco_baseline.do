/*	Market Structure, Oligopsony Power, and Productivity			(Michael Rubens, UCLA)			- BASELINE MODEL -========================================================*/cd "$station"		// directory defined in china_tobacco_master.do set more offuse ./Data/china_tobacco_data, clear		// load dataset that was compiled in china_tobacco_data.doset matsize 11000						// set matrix maximum sizextset fid yr	// define panelgen const = 1	* revenue sharesgen alphaM = m/rev	gen alphaL = w/revgen dumobs =  lq~=.  & alphaM~=.& alphaL~=. & lemp~=.  & lk~=.		// dummy indicating that necessary variables to estimate model are observed 	 /* 1. Prices and consolidation				--------------------------------*/* Input prices: consolidation effects gen lwq = log(w/q)	// log wage per cigarettelocal m = 6		// set leaf market = countyforeach var of varlist lwq lp lpm   {areg `var' treat02_dq`m' treat_dq`m' post02  yr  if lp~=. & lwq~=. & lpm~=.,  absorb(fid)  cluster(dq6id)		// diff-in-differences regression - Table 1Agen r2 = e(r2)gen str4 r2s = string(r2,"%04.2f")local r2 = r2slocal r2_`var'`n'_dq`m' = substr("`r2'",1,4)drop r2 r2slocal N_`var'_dq`m' = e(N)gen b = _b[treat02_dq`m']gen se = _se[treat02_dq`m']estpost su best store b`var' 		// save results for table 1 (point estimate)replace b = seestpost su b			est store se`var' 		// save results for table 1 (standard error)drop b se}* Input prices: pre-trends gen treat_dq6yr = treat_dq6*yrlocal m = 6foreach var of varlist lwq lp lpm {reg `var' treat_dq`m'yr treat_dq`m'  yr   if yr<2002 &   lp~=. & lwq~=. & lpm~=.,  r  cluster(dq6id)		// test parallel pretrends assumption - Table 1Bgen r2 = e(r2)gen str4 r2s = string(r2,"%04.2f")local r2 = r2slocal r2_`var'`n'_dq`m'_pt = substr("`r2'",1,4)drop r2 r2slocal N_`var'_dq`m'_pt = e(N)gen b = _b[treat_dq`m'yr]gen se = _se[treat_dq`m'yr]estpost su best store b`var'_pt			// save results for table 1 (point estimate)replace b = seestpost su best store se`var'_pt 		// save results for table 1 (standard error)drop b se}  * Factor revenue shares and consolidation (visual)preservegen alphaML = m/w		// material/wage billforvalues m = 2(2)6 {bys treat_dq`m' yr: egen medalphaML_dq`m' = median(alphaML)bys treat_dq`m' yr: egen avalphaML_dq`m' = mean(alphaML)bys treat_dq`m' yr: egen agm_dq`m' = sum(m)bys treat_dq`m' yr: egen agl_dq`m' = sum(w)gen agalphaML_dq`m' = agm_dq`m'/agl_dq`m'}label var medalphaML_dq6 "Material/Labor Costs"local m = 6sort yrtwoway connect agalphaML_dq`m' yr if treat_dq`m' == 0, legend(label(1 "No firms with Q<100K")) lwidth(thick) lcolor(black) msize(large) msize(medlarge) mcolor(black) mfcolor(white) msymbol(square) xlabel(1999(1)2006) || connect agalphaML_dq`m' yr if treat_dq`m'==1 ,lwidth(thick) lpattern(dash)  xtitle("") ytitle("Int. input/Labor Costs", size(medlarge))  msize(medlarge) mcolor(black) mfcolor(white) msymbol(diamond) legend(label(2 "One or more firms with Q<100K"))  lcolor(black) graphregion(color(white)) xlabel(1999(1)2006) ylabel(, angle(0) ) name(ag, replace)graph export "/Users/MichaelRubens/Dropbox/China tobacco/paper/aer_2021_0383/figures/Figure3a.pdf", replace 		// figure 3(a)  twoway connect medalphaML_dq`m' yr if treat_dq`m' == 0, legend(label(1 "No firms with Q<100K")) lwidth(thick) lcolor(black) msize(medlarge) mcolor(black) mfcolor(white) msymbol(square) xlabel(1999(1)2006)  || connect medalphaML_dq`m' yr if treat_dq`m'==1 ,lwidth(thick) lpattern(dash)  xtitle("") ytitle("Int. input/Labor Costs", size(medlarge)) msize(medlarge) mcolor(black) mfcolor(white) msymbol(diamond) legend(label(2 "One or more firms with Q<100K"))  lcolor(black) graphregion(color(white)) xlabel(1999(1)2006) ylabel(, angle(0) ) name(ag, replace)graph export "/Users/MichaelRubens/Dropbox/China tobacco/paper/aer_2021_0383/figures/Figure3b.pdf", replace  // figure 3(b)restore  * How much leaf price variation within counties?reg lpm i.dq6id i.yrareg lpm i.dq6id i.yr , absorb(fid)  	/* 2. Production function---------------------------*//* Dynamic panel approach */xtset fid yrforeach var of varlist lq lk lemp treat_dq6 treat02_dq6 post02 luw lp lm{gen `var'_lag = L.`var'		// make lagged variables} * Estimationgmm (lq - {rho}*L.lq - ({bk})*(lk-{rho}*L.lk) - {bl}*(lemp - {rho}*L.lemp)  - {bp}*(lp - {rho}*L.lp) /// - {bc1}*(treat02_dq6 - {rho}*L.treat02_dq6) - {bc2}*(treat_dq6 - {rho}*L.treat_dq6)- {bc3}*(post02 - {rho}*L.post02)- {bw}*(luw - {rho}*L.luw)  - {c}*(1-{rho}) )   , ///inst(lk   luw lp    L.lemp    L.lk L.lp   L.luw treat_dq6 treat02_dq6 post02 )    //Table 2A	matrix pfest_end = e(b)	// save coefficients into matrixgen beta_k_bb = pfest_end[1,2]gen beta_l_bb = pfest_end[1,3]gen beta_p_bb = pfest_end[1,4]gen beta_c1_bb = pfest_end[1,5]gen beta_c2_bb = pfest_end[1,6]gen beta_c3_bb = pfest_end[1,7]gen beta_uw_bb = pfest_end[1,8]gen beta_c_bb = pfest_end[1,9]gen scale_bb = beta_k_bb + beta_l_bb * R-squared -  Table 2Apreservegen obs = lq~=. & L.lq~=. & lk~=. & L.lk~=. & lemp~=. & L.lemp~=. & lm ~=. & L.lm~=. & lp~=. & L.lp~=. & luw~=. & L.luw~=.keep if obs==1gen lqhat = beta_l_bb*lemp + beta_k_bb*lk  + beta_p_bb*lp + beta_uw_bb*luw + beta_c_bb  + beta_c1_bb*treat02_dq6 + beta_c2_bb*treat_dq6 + beta_c3_bb*post02egen avlq = mean(lq)gen eps = (lq-lqhat)^2gen var = (lq-avlq)^2collapse(sum) eps vargen r2 = 1 - eps/vargen str4 r2s = string(r2,"%04.2f")local r2 = r2sdrop r2s r2local r2_pf_bb = substr("`r2'",1,4)di "`r2_pf_bb'"local N_pf_bb= e(N)restore gen ltfp_bb = lq - beta_l_bb*lemp - beta_k_bb*lk   - beta_c_bb	// make tfp residualgen tfp_bb = exp(ltfp_bb)    * Save results for table 2A (point estimates, see bootstrapping file for S.E.s)gen bl = beta_l_bbgen bk = beta_k_bbgen scale = scale_bbestpost su bl bk scale		 est store pf_bbdrop bl bk  scale/* OLS */* Estimationreg lq lk lemp lp   luw  treat_dq6 treat02_dq6 post02  		 //Table 2B* R-squaredgen r2 = e(r2)gen str4 r2s = string(r2,"%04.2f")local r2 = r2slocal r2_pf_ols = substr("`r2'",1,4)di "`r2_pf_ols'"drop r2 r2slocal N_pf_ols = e(N)gen beta_l_ols = _b[lemp]gen beta_k_ols = _b[lk]gen beta_c_ols = _b[_cons]gen beta_p_ols = _b[lp]gen scale_ols = beta_l_ols+beta_k_olsgen bl = beta_l_olsgen bk = beta_k_olsgen scale = scale_ols* Save results for table 2B (point estimates, see bootstrapping file for S.E.s)estpost su bl bk scale 		 est store pf_olsdrop bl bk  scale   /* 3. Markdown estimation  -----------------------------------------------------------------*/  * Markups and markdowns forvalues m = 2(2)6 { gen md0_dq`m' = (1/alphaM)*(1 -alphaL/beta_l_bb)		 gen md1_dq`m' = (1/alphaM)*(1 -alphaL/beta_l_ols)forvalues n= 0/1{gen mu`n'_dq`m'  =1gen lmu`n'_dq`m'  =log(mu`n'_dq`m')gen lmd`n'_dq`m'  = log(md`n'_dq`m')gen ltfp`n'_dq`m' = ltfp_bb}} * Markdown moments: save results for table 2Bforvalues n = 0(1)1  {forvalues m = 6(2)6 {gen a_md = md`n'_dq`m'egen m_md = median(md`n'_dq`m')  if dumobs==1 sum a_md m_md  if dumobs==1 estpost su a_md m_md  if dumobs==1 est store md`n'_dq`m'drop a_md m_md}}  * Markdown determinants - heterogeneitygen dsoe = typeid==1gen luerate = log(pop_unemp/pop) bys dq6id yr: egen nf_dq6 = sum(open)drop if nf_dq6==0tab nf_dq6, gen(nf_dq6_) reg lmd0_dq6   dsoe lrev lstax  luerate     nf_dq6_1 nf_dq6_2   		// table A11mat coef_det = e(b)local N_det = e(N) gen det_dsoe = coef_det[1,1]gen det_lrev = coef_det[1,2]gen det_lstax = coef_det[1,3]gen det_luerate = coef_det[1,4]gen det_nf_dq6_1 = coef_det[1,5]gen det_nf_dq6_2 = coef_det[1,6]* Save determinants to table A11 (for SE see bootstrapping file)estpost su det* est store det_mddrop det*/* 4. Consolidation treatment effects-----------------------------------------*/* Treatment effects - baseline local m = 6 forvalues n = 0(1)1  {forvalues m = 2(2)6 {foreach var in "md" "tfp"   {areg l`var'`n'_dq`m' treat02_dq`m'  post02   yr  if dumobs==1  ,   absorb(fid) r 		// Table 3A gen th_l`var'`n'_dq`m'=_b[treat02_dq`m']							gen r2 = e(r2)gen str4 r2s = string(r2,"%04.2f")local r2 = r2slocal r2_`var'`n'_dq`m' = substr("`r2'",1,4)drop r2 r2slocal N_`var'`n'_dq`m' = e(N)}}}   * Save results for table 3Agen th =.forvalues n = 0(1)1  {forvalues m = 2(2)6 {foreach var in "lmd" "ltfp"   {	replace th = th_`var'`n'_dq`m'estpost su thest store th_`var'`n'_dq`m'}}}   * Visual pretrends - Figure 2A xtreg lmd0_dq6   i.yr##i.treat_dq6   ,  fe  rmargins yr#treat_dq6marginsplot, xdimension(yr) graphregion(color(white))  xtitle("Year")  ytitle("log(Markdown)")   /// plot1opts(msymbol(none)  lwidth(thick) msize(large) lcolor(black ))   ciopts(lcolor(black) lpattern(solid)) plot2opts(msymbol(none) ///	lpattern(dash) lwidth(thick) lcolor(black ) msize(large) legend(label(2 "CONS"))   ) ///legend(order( 3 "No firms with Q<100K" 4 "One or more firms with Q<100K" )) title("")  graph export "/Users/MichaelRubens/Dropbox/China tobacco/paper/aer_2021_0383/figures/FigureA2a.pdf", replacextreg ltfp_bb     i.yr##i.treat_dq6  , fe  rmargins yr#treat_dq6marginsplot, xdimension(yr) graphregion(color(white))  xtitle("Year")  ytitle("log(TFP)")  ///plot1opts(msymbol(none)  lwidth(thick) msize(large) lcolor(black ))   ciopts(lcolor(black) lpattern(solid)) plot2opts(msymbol(none) ///	  lpattern(dash) lwidth(thick) lcolor(black ) msize(large) legend(label(2 "CONS"))   ) ///legend(order( 3 "No firms with Q<100K" 4 "One or more firms with Q<100K" )) title("")  graph export "/Users/MichaelRubens/Dropbox/China tobacco/paper/aer_2021_0383/figures/FigureA2b.pdf", replace    * Pre-trends  forvalues m = 6(2)6 {forvalues n = 0(1)1  {foreach var in "md"  "tfp" {reg l`var'`n'_dq`m'  treat_dq`m' treat_dq`m'yr  yr   if yr< 2002  & dumobs==1,     rgen th1_`var'`n'_dq`m' = _b[treat_dq`m'yr]}}}   /* 5. Allocative efficiency-----------------------------------------*/* Aggregate productivity and outputsave ./tempfiles/data_temp, replace local m = 2local t = "02"keep if tfp_bb~=.keep if dumobs==1bys dq`m'id yr: egen agq_dq`m' = sum(q)bys dq`m'id yr: egen avq_dq`m' = mean(q)bys yr: egen empyr = sum(emp)gen sempyr = emp/empyrgen wtfp_bb = tfp_bb*sempyrbys dq`m'id yr: egen agtfp_bb = sum(wtfp_bb)bys dq`m'id yr: egen avtfp_bb = mean(tfp_bb)gen retfp_bb =  avtfp_bb-agtfp_bbcollapse(mean) avq_dq`m' agq_dq`m' avtfp_bb agtfp_bb retfp_bb, by(const yr dq`m'id treat_dq`m' treat`t'_dq`m' post`t')foreach var of varlist    av* ag* {gen l`var' = log(`var')}xtset dq`m'id yrgen lreal_bb_dq`m' = lagtfp_bb - lavtfp_bb gen lrealq_dq`m' = lagq_dq`m'-lavq_dq`m'foreach var in "lagtfp_bb" "lavtfp_bb" "lreal_bb" "lagq" "lavq" "lrealq"{ areg `var'   treat`t'_dq`m' post`t' treat_dq`m' yr , absorb(dq`m'id) r 			// Table 3B and 3Cgen th_`var'_dq`m' = _b[treat`t'_dq`m']gen r2 = e(r2)gen str4 r2s = string(r2,"%04.2f")local r2 = r2slocal r2_`var'`n'_dq`m' = substr("`r2'",1,4)drop r2 r2slocal N_`var'_dq`m' = e(N)} collapse th*, by(const)save ./tempfiles/th_agprod_dq`m', replace use ./tempfiles/data_temp, clearforvalues m = 2(2)2 {merge m:1 const using ./tempfiles/th_agprod_dq`m', nogen} * Save estimates for table 3B and 3Cforeach var in "lagtfp_bb" "lavtfp_bb" "lreal_bb" "lavq" "lagq" "lrealq"  { replace th = th_`var'_dq2estpost su thest store th_`var'_dq2}save ./tempfiles/data_cf, replace /*  Bootstrapping  ----------------------------*/do ./bootstrap/china_tobacco_baseline_bs		// file that bootstraps the standard errors/* Write tables ----------------------------*/** Table 1: descriptive evidence* Input prices: treatment effects gen b = 1label var b "Treatment*1(Year$\geq$2002)"esttab blwq  selwq  blpm  selpm   blp  selp  using "/Users/MichaelRubens/Dropbox/China tobacco/paper/aer_2021_0383/tables/table1.tex", replace ///prehead("\textit{panel A: Treatment effects} " &  \multicolumn{2}{c}{log(Labor cost/output)} &  \multicolumn{2}{c}{log(Leaf cost/output)} &  \multicolumn{2}{c}{log(Revenue/output)} \\ \cline{2-7})   ///mtitle("Est." "S.E." "Est." "S.E." "Est." "S.E.")   ///cells(mean(fmt(3))) label booktabs nonum noobs collabels(none) gaps f  prefoot(\vspace{-0.75em} \\ \vspace{0.25em} R-squared &  \multicolumn{2}{c}{`r2_lwq_dq6'} &  \multicolumn{2}{c}{`r2_lpm_dq6'} &  \multicolumn{2}{c}{`r2_lp_dq6'} ///\vspace{0.25em} \\ Observations &  \multicolumn{2}{c}{`N_lwq_dq6'} &  \multicolumn{2}{c}{`N_lpm_dq6'} &  \multicolumn{2}{c}{`N_lp_dq6'}  \vspace{0.5em} \\  )  posthead( \hline &&&\\   )  * Input prices: pre-trendslabel var b "Treatment*Year "esttab blwq_pt selwq_pt blpm_pt selpm_pt  blp_pt selp_pt using "/Users/MichaelRubens/Dropbox/China tobacco/paper/aer_2021_0383/tables/table1.tex", append ///prehead(\hline "\textit{panel B: Pre-2002 trends }" &  \multicolumn{2}{c}{log(Labor cost/output)} &  \multicolumn{2}{c}{log(Leaf cost/output)} &  \multicolumn{2}{c}{log(Revenue/output)}\\ \cline{2-7})   /// mtitle("Est." "S.E." "Est." "S.E." "Est." "S.E.")   ///cells(mean(fmt(3))) label booktabs nonum noobs collabels(none) gaps f    prefoot(\vspace{-0.75em} \\ \vspace{0.25em}   R-squared &  \multicolumn{2}{c}{`r2_lwq_dq6_pt'} &  \multicolumn{2}{c}{`r2_lpm_dq6_pt'} &  \multicolumn{2}{c}{`r2_lp_dq6_pt'} /// \vspace{0.25em} \\ Observations &  \multicolumn{2}{c}{`N_lwq_dq6_pt'} &  \multicolumn{2}{c}{`N_lpm_dq6_pt'} &  \multicolumn{2}{c}{`N_lp_dq6_pt'}  \vspace{0.5em} \\ \hline  )  posthead( \hline &&&\\   )  drop b    ** Table 2: model estimates* Production function  gen bl = 1gen bk = 1gen scale = 1label var bl "Output elasticity of labor"label var bk "Output elasticity of capital"label var scale "Scale parameter"esttab pf_ols pf_ols_se pf_bb pf_bb_se   using "/Users/MichaelRubens/Dropbox/China tobacco/paper/aer_2021_0383/tables/table2.tex", replace ///prehead("\textit{panel A: Production function}" &  \multicolumn{2}{c}{Ordinary least squares} &   \multicolumn{2}{c}{Dynamic panel}    \\ \cline{2-5})   /// mtitle("Est." "S.E." "Est." "S.E." )   ///cells(mean(fmt(3))) label booktabs nonum noobs collabels(none) gaps f    prefoot(\vspace{-0.75em} \\ \vspace{0.25em}   R-squared &    \multicolumn{2}{c}{`r2_pf_ols'} &  \multicolumn{2}{c}{`r2_pf_bb'}   ///\vspace{0.25em}  \\ Observations &  \multicolumn{2}{c}{`N_pf_ols'} &    \multicolumn{2}{c}{`N_pf_bb'}  \vspace{0.5em} \\ \hline )  posthead( \hline &&&\\  ) drop bl bk scale * Markdowns and markupsgen a_md  = .gen m_md  = .label var a_md  "Average"label var m_md  "Median"esttab  md1_dq6 md1_dq6_se   md0_dq6 md0_dq6_se      using "/Users/MichaelRubens/Dropbox/China tobacco/paper/aer_2021_0383/tables/table2.tex", append ///prehead("\textit{panel B: Leaf price markdown}" &  \multicolumn{2}{c}{ Ordinary least squares } &   \multicolumn{2}{c}{ Dynamic panel }    \\ \cline{2-5} ) ///mtitle("Est." "S.E." "Est." "S.E."   )   ///cells(mean(fmt(3))) label booktabs nonum noobs collabels(none) gaps f      prefoot(\vspace{-0.75em}    \\ \hline )  posthead( \hline &&&\\  )    ** Table 3: treatment effects* Firm-level treatment effectsgen th =.label var th "Treatment*1(Year $\geq$ 2002)" esttab  th_lmd0_dq6 th_lmd0_dq6_se  th_ltfp0_dq6 th_ltfp0_dq6_se using "/Users/MichaelRubens/Dropbox/China tobacco/paper/aer_2021_0383/tables/table3.tex", replace  ///prehead(  "\textit{panel A: Markdown and productivity}" &  \multicolumn{2}{c}{log(Markdown)} &     \multicolumn{2}{c}{log(Productivity)} \\ \cline{2-7}   )   /// mtitle("Est." "S.E." "Est." "S.E." "Est." "S.E.")   ///cells(mean(fmt(3))) label booktabs nonum noobs collabels(none) gaps f    prefoot(\vspace{-0.75em} \\  \vspace{0.25em}   R-squared &  \multicolumn{2}{c}{`r2_md0_dq6'}  &  \multicolumn{2}{c}{`r2_tfp0_dq6'}   ///\vspace{0.25em}    \\ Observations &  \multicolumn{2}{c}{`N_md0_dq6'}  &  \multicolumn{2}{c}{`N_tfp0_dq6'}  \\ &&&& \\ \hline )  posthead( \hline &&&\\   ) * Allocative effects (market-level)label var th "Treatment*1(Year $\geq$ 2002)" esttab  th_lagtfp_bb_dq2 th_lagtfp_bb_dq2_se  th_lavtfp_bb_dq2 th_lavtfp_bb_dq2_se th_lreal_bb_dq2 th_lreal_bb_dq2_se using "/Users/MichaelRubens/Dropbox/China tobacco/paper/aer_2021_0383/tables/table3.tex", append  ///prehead(  "\textit{panel B: Allocative efficiency}" &  \multicolumn{2}{c}{log(Agg. TFP)} &   \multicolumn{2}{c}{log(Avg. TFP)}  & \multicolumn{2}{c}{Reallocation} \\ \cline{2-7}   )   /// mtitle("Est." "S.E." "Est." "S.E." "Est." "S.E.")   ///cells(mean(fmt(3))) label booktabs nonum noobs collabels(none) gaps f    prefoot(\vspace{-0.75em} \\  \vspace{0.25em}   R-squared &  \multicolumn{2}{c}{`r2_lagtfp_bb_dq2'}&  \multicolumn{2}{c}{`r2_lavtfp_bb_dq2'} &  \multicolumn{2}{c}{`r2_lreal_bb_dq2'}   ///\vspace{0.25em}    \\ Observations &  \multicolumn{2}{c}{`N_lagtfp_bb_dq2'}  &  \multicolumn{2}{c}{`N_lavtfp_bb_dq2'}  &  \multicolumn{2}{c}{`N_lreal_bb_dq2'}  \\ &&&& \\ \hline )  posthead( \hline &&&\\   ) * Output (market-level)label var th "Treatment*1(Year $\geq$ 2002)" esttab  th_lagq_dq2 th_lagq_dq2_se th_lavq_dq2 th_lavq_dq2_se  th_lrealq_dq2 th_lrealq_dq2_se using "/Users/MichaelRubens/Dropbox/China tobacco/paper/aer_2021_0383/tables/table3.tex", append  ///prehead(  "\textit{panel C: Output}" &  \multicolumn{2}{c}{log(Agg. output)} &   \multicolumn{2}{c}{log(Avg. output)}  & \multicolumn{2}{c}{Reallocation} \\ \cline{2-7}   )   /// mtitle("Est." "S.E." "Est." "S.E." "Est." "S.E.")   ///cells(mean(fmt(3))) label booktabs nonum noobs collabels(none) gaps f    prefoot(\vspace{-0.75em} \\  \vspace{0.25em}   R-squared &  \multicolumn{2}{c}{`r2_lagq_dq2'}&  \multicolumn{2}{c}{`r2_lavq_dq2'} &  \multicolumn{2}{c}{`r2_lrealq_dq2'}   ///\vspace{0.25em}    \\ Observations &  \multicolumn{2}{c}{`N_lavq_dq2'}  &  \multicolumn{2}{c}{`N_lagq_dq2'}  &  \multicolumn{2}{c}{`N_lrealq_dq2'}  \\ &&&& \\ \hline )  posthead( \hline &&&\\   ) ** Table A11: markdown heterogeneityforeach var in "det_dsoe" "det_luerate" "det_lrev" "det_lstax"  "det_nf_dq6_1" "det_nf_dq6_2"   {gen `var' = 1}label var det_dsoe "1(SOE)"label var det_lrev "log(Revenue)"label var det_lstax "log(Tax rate)"label var det_luerate "log(Unemp. rate)"label var det_nf_dq6_1 "1(\# Firms = 1)"label var det_nf_dq6_2 "1(\# Firms = 2)"esttab det_md  det_md_se    using "/Users/MichaelRubens/Dropbox/China tobacco/paper/aer_2021_0383/tables/tableA11.tex", replace  ///prehead( & \multicolumn{2}{c}{log(Markdown)}   \\ \cline{2-3})   ///mtitle("Est." "S.E."    ) cells(mean(fmt(3))) label booktabs nonum noobs collabels(none) gaps f   ///prefoot(\vspace{-0.75em} \\    \vspace{0.5em}  \\ \hline)  posthead( \hline  &&\\   )    /* 6. Distributional consequences-------------------------------*/use ./tempfiles/data_cf, clearlocal m = 6 reg lpm yr 	// 0.4% per year growth ratereg luw yr //13.7% per year growth rate  forvalues m = 0(1)6 {gen d`m' = yr==`m'+2000gen td`m' = treat_dq4*d`m'}gen t = treat_dq4gen c= 1reg lpm d0 d1 d2 d3 d4 d5 d6 td0 td1 td2 td3 td4 td5 td6 t c, noconsforeach var of varlist d0 d1 d2 d3 d4 d5 d6 td0 td1 td2 td3 td4 td5 td6 t c {gen b`var' = _b[`var']}gen lpmhat1 = bc + bt if yr==1999gen lpmhat0 = bc  if yr==1999gen lpmhat1_cf = lpmhat1  if yr==1999forvalues m = 0(1)6 {replace lpmhat1 =  bd`m'  +btd`m'  + bc +bt if yr==2000+`m'replace lpmhat0 = bd`m'   + bc   if yr==2000+`m'replace lpmhat1_cf = bd`m'  +btd`m'  + bc +bt if yr==2000+`m' & yr<2002replace lpmhat1_cf = bd`m'   + bc +bt if yr==2000+`m'& yr >=2002} sort yrtwoway  connect lpmhat1 yr, legend(label ( 1 "treat") )  || connect lpmhat0 yr , legend(label ( 2 "control") ) , xline(2001) ///|| connect lpmhat1_cf yr , legend(label ( 3 "cf") ) * Calculate average leaf price with and without policyforeach var in "pmhat1" "pmhat0" "pmhat1_cf" {gen  `var' = exp(l`var')bys yr: egen av`var' = mean(`var') } twoway  connect  pmhat1 yr, legend(label ( 1 "treat") )  || connect  pmhat0 yr , legend(label ( 2 "control") ) , xline(2001) ///|| connect  pmhat1_cf yr , legend(label ( 3 "cf") )  gen pm_real = pmhat1*treat_dq6 +pmhat0*(1-treat_dq6)gen pm_cf = pmhat1_cf*treat_dq6 +pmhat0*(1-treat_dq6)foreach var of varlist pm_real pm_cf {bys yr: egen av`var' = mean(`var')}* Calculate wage/leaf price ratio with and without policybys yr: egen avuw = mean(uw)gen avrat_real = avuw/avpm_realgen avrat_cf = avuw/avpm_cf gen lavrat_real = log(avrat_real)gen lavrat_cf = log(avrat_cf)twoway line  avrat_real  yr, lcolor(black)  lpattern(solid) lwidth(thick) ///|| line  avrat_cf  yr, lcolor(black)lpattern(longdash) lwidth(thick) graphregion(color(white)) ytitle("Wage/Leaf price (2001=0)")twoway line lavrat_real  yr, lcolor(black)  lpattern(solid) lwidth(thick) ///|| line lavrat_cf  yr, lcolor(black)lpattern(longdash) lwidth(thick) graphregion(color(white)) ytitle("Wage/Leaf price (2001=0)")gen avrat_real01 = avrat_real if yr==2001egen normrat = max(avrat_real01)reg lpm yrreg luw yrpreservecollapse uw pm, by(yr)gen luw = log(uw)gen lpm=log(pm)reg luw yrreg lpm yrrestoreforeach var of varlist avrat_real avrat_cf {gen  `var'n = `var'/normrat  }label var avrat_realn "Wage/Leaf price, reality"label var avrat_cfn "Wage/Leaf price, counterfactual"twoway  connect avrat_realn yr, lcolor(black) mcolor(black) mfcolor(white) msize(medlarge) msymbol(square) lpattern(solid) lwidth(thick) ///|| connect avrat_cfn yr, lcolor(black)lpattern(longdash) mcolor(black) mfcolor(white) msize(medlarge) msymbol(diamond) lwidth(thick) graphregion(color(white)) ytitle("Wage/Leaf price (2001=1)")	// Figure 4bys yr: sum avrat_realn avrat_cfn  sum avrat_realn avrat_cfn if yr==2006graph export "/Users/MichaelRubens/Dropbox/China tobacco/paper/aer_2021_0383/figures/Figure4.pdf", replace   