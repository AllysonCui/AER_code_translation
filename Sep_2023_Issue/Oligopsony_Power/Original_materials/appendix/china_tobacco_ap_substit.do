/*	Market Structure, Oligopsony Power, and Productivity			(Michael Rubens, UCLA)	- SUBSTITUTABLE LEAF MODEL  -========================================================*/ cd "$station"set more offuse ./Data/china_tobacco_data, clearset matsize 11000 gen alphaL = w/revgen alphaM = m/revgen dumobs =  lq~=.  & alphaM~=.& alphaL~=. & lemp~=.  & lk~=./* 1. Substitution elasticities ---------------------------------*/ foreach var in "m" "k" {gen lhs_`var' = log(`var'/emp) ivregress 2sls lhs_`var' (luw = dexp_ot pctexp_ot )   i.typeid dhs* i.yr dexp pctexp  lp if dumobs==1, r   first gen sigma_`var' = _b[luw]gen sigma_`var'_se = _se[luw]   gen sigma = sigma_`var'estpost su sigmaest store sigma_`var'replace sigma = sigma_`var'_seestpost su sigma est store sigma_`var'_sedrop sigma} /* 2. Production function---------------------------*//* Dynamic panel approach */xtset fid yrforeach var of varlist lq lk lemp treat_dq6 treat02_dq6 post02 luw lp lm{gen `var'_lag = L.`var'		// make lagged variables} gmm (lq - {rho}*L.lq - ({bk})*(lk-{rho}*L.lk) - {bl}*(lemp - {rho}*L.lemp) - {bm}*(lm - {rho}*L.lm) - {bp}*(lp - {rho}*L.lp)  - {bw}*(luw - {rho}*L.luw) - {bc1}*(treat02_dq6 - {rho}*L.treat02_dq6) - {bc2}*(treat_dq6 - {rho}*L.treat_dq6)- {bc3}*(post02 - {rho}*L.post02) - {c}*(1-{rho}) )     	  , ///	inst(lk      L.lemp   lp luw L.lk L.lp   L.luw L.lm treat02_dq6 treat_dq6 post02 L.treat02_dq6 L.treat_dq6 L.post02 )   conv_maxiter(50)   local N_pf_bb= e(N)mat sub_coef = e(b)gen beta_k_sub = sub_coef[1,2]gen beta_l_sub = sub_coef[1,3]gen beta_m_sub = sub_coef[1,4]gen beta_p_sub = sub_coef[1,5]gen beta_w_sub = sub_coef[1,6]gen beta_c1_sub = sub_coef[1,7]gen beta_c2_sub = sub_coef[1,8]gen beta_c3_sub = sub_coef[1,9]gen beta_c_sub = sub_coef[1,10]gen scale_sub = beta_l_sub + beta_k_sub+ beta_m_subgen ltfp_sub = lq - beta_l_sub*lemp - beta_k_sub*lk - beta_m_sub*lm   - beta_c_sub 		// make tfp residualgen tfp_sub = exp(ltfp_sub)sum tfp* // R^2preservekeep if ltfp_sub~=. & L.ltfp_sub~=.gen lqhat = beta_l_sub*lemp + beta_k_sub*lk + beta_m_sub*lm + beta_c_sub + beta_p_sub*lp + beta_w_sub*luw+ beta_c1_sub * treat02_dq6 +   beta_c2_sub*treat_dq6 +  beta_c3_sub*post02egen avlq = mean(lq)gen eps = (lq-lqhat)^2gen var = (lq-avlq)^2collapse(sum) eps vargen r2 = 1-eps/varsum r2gen str4 r2s = string(r2,"%04.2f")local r2 = r2slocal r2_pf_sub = substr("`r2'",1,4)drop r2 r2slocal N_pf_sub = e(N)restore// save results for tables gen bl = beta_l_subgen bk = beta_k_subgen bm = beta_m_subgen scale = scale_subestpost su bl bk bm scaleest store pf_subdrop bl bk  scale    /* 3. Markdown estimation  -----------------------------------------------------------------*/   // Markups and markdowns gen md_sub = (beta_m_sub/alphaM)/(beta_l_sub/alphaL)gen lmd_sub  = log(md_sub)gen mu_sub = beta_l_sub/alphaLgen lmu_sub = log(mu_sub) sum md_sub if dumobs==1, dsum mu_sub if dumobs==1, d  // Markdown moments: save results for table drop mforeach var in "mu" "md" {foreach mod in "sub"  {gen a  = `var'_`mod'egen m  = median(`var'_`mod')  if dumobs==1 sum a  m   if dumobs==1 estpost su a  m   if dumobs==1 est store `var'_`mod'drop a  m  }}/* 4. Consolidation treatment effects-----------------------------------------*/// Treatment effects - baseline foreach mod in "sub"   {  foreach var in "md" "tfp"   {areg l`var'_`mod' treat02_dq6  post02   yr  if dumobs==1  ,   absorb(fid) r gen th_l`var'_`mod'=_b[treat02_dq`m']gen r2 = e(r2)gen str4 r2s = string(r2,"%04.2f")local r2 = r2slocal r2_`var'_`mod' = substr("`r2'",1,4)drop r2 r2slocal N_`var'_`mod' = e(N)}}// save results for tables gen th =.foreach mod in "sub"   {  foreach var in "lmd" "ltfp"   {	replace th = th_`var'_`mod'estpost su thest store th_`var'_`mod'}}      	/*  Bootstrapping  ----------------------------*/ do ./bootstrap/china_tobacco_ap_substit_bs  /* Write tables ----------------------------*/ ** Table A6 // Production function  gen bl = 1gen bk = 1gen bm = 1gen scale = 1label var bl "Output elasticity of labor"label var bm "Output elasticity of materials"label var bk "Output elasticity of capital"label var scale "Scale parameter" esttab pf_sub pf_sub_se    using "/Users/MichaelRubens/Dropbox/China tobacco/Paper/aer_2021_0383/tables/tableA6.tex", replace ///prehead("\textit{panel A: Production function}" &  \multicolumn{2}{c}{Substitutable leaf}     \\ \cline{2-3})   /// mtitle("Est." "S.E."   )   ///cells(mean(fmt(3))) label booktabs nonum noobs collabels(none) gaps f    prefoot(\vspace{-0.75em} \\ \vspace{0.25em}   R-squared &    \multicolumn{2}{c}{`r2_pf_sub'}     ///\vspace{0.25em}  \\ Observations &  \multicolumn{2}{c}{`N_pf_sub'}   \vspace{0.5em} \\ \hline )  posthead(\hline   &&\\ ) drop bl bk scale  // Markdowns and markupsgen a = .gen m = .label var a "Average markdown"label var m "Median markdown"esttab  md_sub md_sub_se  mu_sub mu_sub_se     using "/Users/MichaelRubens/Dropbox/China tobacco/Paper/aer_2021_0383/tables/tableA6.tex", append ///prehead("\textit{panel B: Markdowns and markups}" &  \multicolumn{2}{c}{Markdown} &  \multicolumn{2}{c}{Markup}    \\ \cline{2-5}) ///mtitle("Est." "S.E."  "Est." "S.E."      )   ///cells(mean(fmt(3))) label booktabs nonum noobs collabels(none) gaps f    prefoot( \vspace{-0.5em} \\ \hline)  posthead( \hline && && \\  )   //  treatment effectsgen th =.label var th "Treatment*1(Year $\geq$ 2002)" esttab  th_lmd_sub th_lmd_sub_se  th_ltfp_sub th_ltfp_sub_se     using "/Users/MichaelRubens/Dropbox/China tobacco/Paper/aer_2021_0383/tables/tableA6.tex", append  ///prehead(  "\textit{panel C: Treatment effect}" &    \multicolumn{2}{c}{log(Markdown)} &    \multicolumn{2}{c}{log(TFP)}    \\\cline{2-5}   )   /// mtitle("Est." "S.E." "Est." "S.E."   )   ///cells(mean(fmt(3))) label booktabs nonum noobs collabels(none) gaps f    prefoot(\vspace{-0.75em} \\  \vspace{0.25em}   R-squared &  \multicolumn{2}{c}{`r2_md_sub'} &  \multicolumn{2}{c}{`r2_tfp_sub'}    ///\vspace{0.25em}    \\ Observations &  \multicolumn{2}{c}{`N_md_sub'}  &  \multicolumn{2}{c}{`N_tfp_sub'}    \vspace{0.5em} \\ \hline )  posthead( \hline &&\\   )   